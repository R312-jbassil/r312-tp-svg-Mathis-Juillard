---
import Layout from '../layouts/Layout.astro';
---
<Layout>
  <!-- Header local -->
  <div class="flex items-center justify-between mb-6">
    <div class="breadcrumbs text-sm">
      <ul>
        <li><a href="/" class="link">Accueil</a></li>
        <li>Générateur</li>
      </ul>
    </div>
    <div class="badge badge-lg">Hugging Face</div>
  </div>

  <!-- Carte de saisie -->
  <div class="card bg-base-100 shadow-xl border border-base-300 mb-6">
    <div class="card-body gap-3">
      <div class="flex items-center justify-between">
        <h2 class="card-title">Entrer un prompt</h2>
        <div class="join hidden sm:inline-flex">
          <button class="btn btn-ghost btn-xs join-item ex" data-prompt="a red car">Ex: car</button>
          <button class="btn btn-ghost btn-xs join-item ex" data-prompt="a cute robot head">robot</button>
          <button class="btn btn-ghost btn-xs join-item ex" data-prompt="a blue rocket">rocket</button>
        </div>
      </div>

      <label class="form-control w-full">
        <div class="label">
          <span class="label-text">Prompt</span>
          <span class="label-text-alt">Décris l’objet à dessiner</span>
        </div>
        <textarea id="user-prompt" class="textarea textarea-bordered min-h-28" placeholder="a red car"></textarea>
      </label>

      <div class="card-actions justify-end">
        <button id="clear" class="btn btn-ghost">Effacer</button>
        <button id="generate-button" class="btn btn-primary">Générer</button>
      </div>

      <div id="alert" class="hidden"></div>
    </div>
  </div>

  <!-- Résultats -->
  <div class="grid gap-6 grid-cols-1 lg:grid-cols-2">
    <!-- Aperçu -->
    <div class="card bg-base-100 shadow-xl border border-base-300">
      <div class="card-body">
        <h2 class="card-title">Aperçu</h2>
        <div id="svg-container" class="min-h-72 rounded-box border border-base-300 grid place-items-center">
          <span class="opacity-60">Le SVG généré s’affichera ici</span>
        </div>
      </div>
    </div>

    <!-- Code -->
    <div class="card bg-base-100 shadow-xl border border-base-300">
      <div class="card-body">
        <h2 class="card-title">Code SVG</h2>
        <pre class="mockup-code text-sm overflow-auto max-h-[520px]"><code id="svg-output" class="whitespace-pre-wrap break-words"></code></pre>
        <div class="card-actions justify-end">
          <button id="copy" class="btn btn-secondary btn-sm">Copier</button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script type="module">
  // Helpers
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));

  const btn = $('#generate-button');
  const clearBtn = $('#clear');
  const out = $('#svg-output');
  const box = $('#svg-container');
  const alertBox = $('#alert');
  const copyBtn = $('#copy');
  const promptEl = /** @type {HTMLTextAreaElement|null} */ ($('#user-prompt'));

  const showAlert = (type, text) => {
    alertBox.className = `alert alert-${type} mb-2`;
    alertBox.textContent = text;
  };

  // Exemples rapides
  $$('.ex').forEach(b => b.addEventListener('click', () => {
    if (promptEl) promptEl.value = b.dataset.prompt || '';
  }));

  // Fetch endpoint
  async function generateSVG(prompt) {
    const res = await fetch('/api/generateSVG', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt }),
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch { throw new Error(`Réponse non-JSON (probable 404/500): ${text.slice(0, 120)}…`); }
    if (!res.ok) throw new Error(data.error || 'Erreur API');
    return data.svg;
  }

  async function handleSubmit() {
    const prompt = (promptEl?.value || '').trim();
    if (!prompt) {
      showAlert('warning', 'Écris un prompt avant de générer.');
      return;
    }
    alertBox.className = 'hidden';
    box.innerHTML = `<span class="loading loading-ring loading-lg"></span>`;
    out.textContent = '';
    btn.disabled = true;

    try {
      const svg = await generateSVG(prompt);
      if (!svg) {
        showAlert('info', "Le modèle n'a pas renvoyé de balise <svg>.");
        box.innerHTML = `<div class="opacity-60">Aucun SVG détecté</div>`;
        return;
      }
      out.textContent = svg;
      box.innerHTML = svg;
    } catch (e) {
      console.error(e);
      showAlert('error', String(e?.message ?? 'Erreur de génération'));
      box.innerHTML = `<div class="opacity-60">Erreur…</div>`;
    } finally {
      btn.disabled = false;
    }
  }

  btn?.addEventListener('click', handleSubmit);
  clearBtn?.addEventListener('click', () => {
    if (promptEl) promptEl.value = '';
    out.textContent = '';
    box.innerHTML = `<span class="opacity-60">Le SVG généré s’affichera ici</span>`;
    alertBox.className = 'hidden';
  });

  copyBtn?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(out.textContent || '');
      showAlert('success', 'SVG copié dans le presse-papiers ✅');
    } catch {
      showAlert('error', 'Impossible de copier');
    }
  });
</script>
